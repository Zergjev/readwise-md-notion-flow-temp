name: Drive Poller (Watcher → Fetcher → Transcriber → Summarizer → Keywords)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes

jobs:
  poll_fetch_transcribe:
    runs-on: ubuntu-latest
    env:
      GOOGLE_SERVICE_JSON: ${{ secrets.GOOGLE_SERVICE_JSON }}
      DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
      OPENAI_API_KEY: ${{ secrets.OPEN_AI_KEY }} # your code also falls back to this
      AUDIO_OUTPUT_DIR: downloads/audio
      TRANSCRIPT_OUTPUT_DIR: outputs/transcripts
      WHISPER_MODEL: base
      WHISPER_COMPUTE_TYPE: int8

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: System dependencies (ffmpeg for audio decoding)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Watcher → /tmp/new_files.json
        run: |
          python -m agents.voice2notion.apps.drive_watcher.run --out /tmp/new_files.json --limit 20
          python - <<'PY'
          import json, sys
          try:
              with open('/tmp/new_files.json', 'r', encoding='utf-8') as f:
                  items = json.load(f)
              print(f"Watcher emitted {len(items)} file(s).")
          except Exception as e:
              print(f"Failed to read watcher output: {e}")
              sys.exit(1)
          PY

      - name: Run Fetcher for each file
        run: |
          python - <<'PY'
          import os, json, subprocess, sys
          path = '/tmp/new_files.json'
          try:
              with open(path, 'r', encoding='utf-8') as f:
                  items = json.load(f)
          except Exception as e:
              print(f"No JSON to process or invalid JSON: {e}")
              sys.exit(0)

          if not isinstance(items, list) or not items:
              print("No files to fetch.")
              sys.exit(0)

          print(f"Processing {len(items)} file(s)…")
          for obj in items:
              env = os.environ.copy()
              env['MATRIX_FILE'] = json.dumps(obj)
              label = obj.get('file_name') or obj.get('file_id') or 'unknown'
              print(f"→ Fetching: {label}")
              subprocess.check_call(
                  [sys.executable, "-m", "agents.voice2notion.apps.fetcher.run"],
                  env=env,
              )
          PY

      - name: Run Transcriber (produce EN & ES)
        env:
          AUDIO_INPUT_DIR: ${{ env.AUDIO_OUTPUT_DIR }}
          TRANSCRIPT_OUTPUT_DIR: ${{ env.TRANSCRIPT_OUTPUT_DIR }}
          WHISPER_MODEL: ${{ env.WHISPER_MODEL }}
          WHISPER_COMPUTE_TYPE: ${{ env.WHISPER_COMPUTE_TYPE }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        run: |
          python -m agents.voice2notion.apps.transcriber.run \
            --in-dir $AUDIO_INPUT_DIR \
            --out-dir $TRANSCRIPT_OUTPUT_DIR \
            --model $WHISPER_MODEL \
            --compute-type $WHISPER_COMPUTE_TYPE

      - name: Run Summarizer (create bullet summaries)
        run: |
          python -m agents.voice2notion.apps.summarizer.run --in-dir outputs

      - name: Run Keywords Extractor (5 one-word keywords)
        run: |
          python -m agents.voice2notion.apps.keywords.run --in-dir outputs

      - name: List outputs
        run: |
          echo "=== Audio files ==="
          ls -lah downloads/audio || true
          echo "=== Transcript folders ==="
          ls -lah outputs || true
          echo "=== Inside latest transcript folder ==="
          ls -lah outputs/*-transcripts || true

      - name: Upload audio (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-audio
          path: downloads/audio
          if-no-files-found: warn

      - name: Upload transcripts (latest numbered folder)
        uses: actions/upload-artifact@v4
        with:
          name: transcripts
          path: outputs/*-transcripts
          if-no-files-found: warn
